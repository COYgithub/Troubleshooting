# 高速列车轴承数据预处理与特征提取

## 文档信息
- **脚本名称**：preprocess_features.py
- **版本**：1.0
- **生成日期**：2025-09-21
- **目的**：本脚本用于处理高速列车轴承振动数据，包括源域（试验台数据）和目标域（列车数据）的预处理、特征提取。支持多种格式的数据读取、重采样、滑动窗口分段，以及时域、频域、包络谱和时频特征的提取。最终将特征保存为CSV文件，并可选生成时频图像和报告。

## 概述
本脚本针对高速列车轴承故障诊断任务设计，支持以下核心功能：
1. **数据读取**：支持`.mat`（源域试验台数据，包含DE/FE/BA传感器信号和RPM）、`.txt`或`.csv`（目标域列车数据，采样率32kHz，长度8s，编号A~P）。
2. **预处理**：所有数据重采样至48kHz；使用滑动窗口（窗口1s/48000点，步长0.5s）分段。
3. **特征提取**：
   - **时域**：均值、标准差、RMS、峰值、峭度、偏度、脉冲指标、波形指标、清隙指标。
   - **频域**：FFT能量谱、谱质心、谱带宽、特定频带能量、轴承特征频率（BPFO/BPFI/BSF）处幅值和能量（基于轴承参数和RPM计算）。
   - **包络分析**：Hilbert变换获取包络，提取包络统计和包络谱特征。
   - **时频**：STFT和CWT，提取能量、峰值频率、集中度等特征；可选保存图像。
4. **输出**：将所有特征保存到CSV文件（每行对应一个窗口），包括元数据（如文件、传感器、标签、RPM）。可选标准化特征并生成报告。
5. **故障类别**：外圈(OR)、内圈(IR)、滚动体(B)、正常(N)。

脚本采用面向对象设计，主要通过`BearingDataProcessor`类实现，支持批量处理数据集。适用于迁移学习或故障诊断模型的特征工程。

## 依赖库
脚本依赖以下Python库（使用pip安装）：
- `numpy`：数值计算和数组操作。
- `pandas`：数据框处理和CSV读写。
- `scipy`：信号处理（io、signal、fft、hilbert、stft、resample）。
- `matplotlib`：绘图（时频图像）。
- `pywt`：连续小波变换（CWT）。
- `sklearn`：标准化（StandardScaler）和模型保存（joblib）。
- `os`、`warnings`、`joblib`：文件操作、警告抑制和序列化。

**安装命令示例**：
```
pip install numpy pandas scipy matplotlib pywt scikit-learn
```

**注意**：脚本中禁用了警告（`warnings.filterwarnings('ignore')`），以避免非关键输出干扰。

## 类和方法详细说明

### 类：BearingDataProcessor
轴承数据处理核心类。

#### 初始化（__init__）
```python
def __init__(self, target_fs=48000, window_size=1.0, step_size=0.5):
```
- **参数**：
  - `target_fs` (int)：目标采样率（Hz），默认48000。
  - `window_size` (float)：窗口大小（秒），默认1.0。
  - `step_size` (float)：步长（秒），默认0.5。
- **功能**：设置采样参数、窗口样本数、步长样本数。预定义SKF6205（驱动端）和SKF6203（风扇端）轴承几何参数（节径、滚珠直径、滚珠数、接触角）。

#### 方法：calculate_bearing_frequencies
```python
def calculate_bearing_frequencies(self, rpm, bearing_type='SKF6205'):
```
- **参数**：
  - `rpm` (float)：转速（转/分）。
  - `bearing_type` (str)：轴承型号（'SKF6205'或'SKF6203'），默认'SKF6205'。
- **返回**：dict，包含BPFO（外圈故障频率）、BPFI（内圈故障频率）、BSF（滚动体故障频率）和FR（轴频率）。
- **功能**：基于轴承几何和RPM计算特征频率，使用标准公式。

#### 方法：read_mat_file
```python
def read_mat_file(self, file_path):
```
- **参数**：`file_path` (str)：.mat文件路径。
- **返回**：dict，包含DE/FE/BA信号、RPM、故障信息（类型、大小、载荷、位置）和采样率。
- **功能**：加载.mat文件，提取信号和RPM；从文件名解析故障信息；根据数据长度推断采样率（>100000点为48kHz，否则12kHz）。

#### 方法：_parse_filename (私有)
- **功能**：从文件名解析故障类型（B/IR/OR/N）、大小（0.007/0.014/0.021/0.028）、载荷和位置（针对OR）。

#### 方法：read_csv_txt_file
```python
def read_csv_txt_file(self, file_path):
```
- **参数**：`file_path` (str)：.csv或.txt文件路径。
- **返回**：dict，包含信号、采样率（32000Hz）和持续时间。
- **功能**：读取目标域数据，假设第一列为信号。

#### 方法：resample_signal
```python
def resample_signal(self, signal_data, original_fs):
```
- **参数**：`signal_data` (array)：原始信号；`original_fs` (int)：原始采样率。
- **返回**：重采样信号。
- **功能**：使用scipy.resample重采样至目标采样率。

#### 方法：sliding_window_segmentation
```python
def sliding_window_segmentation(self, signal_data):
```
- **参数**：`signal_data` (array)：输入信号。
- **返回**：list，分段信号列表。
- **功能**：使用滑动窗口分段（非重叠步长）。

#### 方法：extract_time_features
```python
def extract_time_features(self, segment):
```
- **参数**：`segment` (array)：信号段。
- **返回**：dict，时域特征（mean, std, rms, peak, skewness, kurtosis, crest_factor, impulse_factor, shape_factor, clearance_factor）。
- **功能**：计算统计和形状指标；自定义偏度和峭度函数处理零方差。

#### 方法：extract_frequency_features
```python
def extract_frequency_features(self, segment, bearing_freqs=None):
```
- **参数**：`segment` (array)；`bearing_freqs` (dict，可选)：特征频率。
- **返回**：dict，频域特征（total_energy, spectral_centroid, spectral_bandwidth, energy_band_1~4, BPFO/BPFI/BSF/FR_amplitude/energy）。
- **功能**：FFT计算能量谱、质心、带宽、频带能量（0-1k,1k-5k,5k-10k,10k-24kHz）；提取特征频率处幅值和附近能量（±10Hz）。

#### 方法：extract_envelope_features
```python
def extract_envelope_features(self, segment):
```
- **参数**：`segment` (array)。
- **返回**：dict，包络特征（envelope_mean/std/rms/peak, envelope_spectral_energy/centroid）。
- **功能**：Hilbert变换获取包络，计算统计和包络谱特征。

#### 方法：extract_timefreq_features
```python
def extract_timefreq_features(self, segment, save_images=False, filename_prefix=""):
```
- **参数**：`segment` (array)；`save_images` (bool)：是否保存图像；`filename_prefix` (str)：图像前缀。
- **返回**：dict，时频特征（stft_energy/peak_freq, time/freq_concentration, cwt_energy/peak_freq）。
- **功能**：STFT（nperseg=1024）和CWT（cmor小波，scales=1-128）；计算能量、峰值频率、集中度；可选保存原始/STFT/CWT/频谱图像（PNG格式）。

#### 方法：_save_timefreq_plots (私有)
- **功能**：生成并保存时频图（4子图：原始信号、STFT、CWT、频谱）。

#### 方法：process_file
```python
def process_file(self, file_path, label=None, rpm=None, save_images=False):
```
- **参数**：`file_path` (str)；`label` (str，可选)：标签；`rpm` (float，可选)；`save_images` (bool)。
- **返回**：pd.DataFrame，特征数据框。
- **功能**：读取文件、重采样、分段、提取所有特征；支持多传感器（源域）或单信号（目标域）；添加元数据。

#### 方法：process_dataset
```python
def process_dataset(self, data_config, output_dir='./features', save_images=False):
```
- **参数**：`data_config` (list[dict])：文件配置（path, label, rpm）；`output_dir` (str)；`save_images` (bool)。
- **返回**：pd.DataFrame，所有特征。
- **功能**：批量处理文件；保存CSV（extracted_features.csv, source/target_domain_features.csv）；标准化数值特征；生成报告。

### 函数：generate_feature_report
```python
def generate_feature_report(df, output_path):
```
- **参数**：`df` (pd.DataFrame)：特征数据框；`output_path` (str)。
- **功能**：生成TXT报告，包括数据统计、标签/传感器/轴承分布、特征类别、数值摘要、配置。

### 函数：main
- **功能**：脚本入口；初始化处理器；自动扫描源域/目标域数据文件夹；配置数据；处理数据集；打印统计；保存源/目标域CSV。

## 运行方法
1. **准备数据**：
   - 源域：放置在`数据集/源域数据集/48kHz_DE_data`下，按故障类别/尺寸/位置组织.mat文件。
   - 目标域：放置在`数据集/目标域数据集`下，A~P编号的.csv/.txt/.mat文件。
   - 项目根目录：脚本会自动设置`root_dir = os.path.dirname(os.getcwd())`，数据在`root_dir/数据集`。

2. **运行脚本**：
   ```bash
   python preprocess_features.py
   ```
   - 输出目录：`./extracted_features`（CSV文件、标准化CSV、scaler.pkl、feature_report.txt）。
   - 时频图像：设置`save_images=True`时保存为PNG（文件名如`<file>_<sensor>_seg<i>_timefreq.png`）。

3. **自定义配置**：
   - 修改`main`中的`data_dir`、`source_base_path`、`target_base_path`。
   - 手动添加`data_config`列表项。
   - 调整初始化参数（如采样率、窗口大小）。

## 示例输出
- **CSV结构**（部分列）：file, sensor, segment, label, rpm, mean, std, rms, ..., BPFO_amplitude, envelope_mean, stft_energy, ...
- **报告示例**（feature_report.txt）：
  ```
  === 轴承振动数据特征提取报告 ===
  生成时间: 2025-09-21 00:00:00
  1. 数据统计
     总样本数: 1000
     总特征数: 50
  2. 标签分布
     N: 300 个样本
     OR: 250 个样本
     ...
  ```

## 注意事项
- **轴承参数**：默认SKF6205/6203；目标域RPM默认600。
- **采样率推断**：源域基于数据长度，可能不准确；手动指定若需。
- **图像保存**：会生成大量PNG文件，建议仅调试时启用。
- **异常处理**：读取失败时打印错误，继续处理其他文件。
- **性能**：大文件分段多时耗时长；使用joblib保存scaler以便后续模型使用。
- **扩展**：可添加更多特征或小波类型；未安装库会导致导入错误。